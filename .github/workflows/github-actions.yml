name: PR Continuous Integration - Mobile App

on:
  push:
    branches: [ develop, master ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v1
        with:
          java-version: '12.x'
      - uses: subosito/flutter-action@v1
        with:
          flutter-version: '2.5.3'
      - run: flutter test

  build-android:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v2
      - uses: subosito/flutter-action@v1
        with:
          flutter-version: '2.5.3'
      - name: Build android apk
        run: |
          flutter pub get
          flutter build apk
      - name: Deploy android apk
        env:
          STAGING_FIREBASE_CI_TOKEN: ${{ secrets.STAGING_FIREBASE_CI_TOKEN }}
          STAGING_ANDROID_APP_ID: ${{ secrets.STAGING_ANDROID_APP_ID }}
          STAGING_FIREBASE_RELEASE_GROUPS: ${{ secrets.STAGING_FIREBASE_RELEASE_GROUPS }}
        run: |
          curl -sL https://firebase.tools | bash
          firebase appdistribution:distribute \
              --token "$STAGING_FIREBASE_CI_TOKEN" \
              --app "$STAGING_ANDROID_APP_ID" \
              --groups "$STAGING_FIREBASE_RELEASE_GROUPS"